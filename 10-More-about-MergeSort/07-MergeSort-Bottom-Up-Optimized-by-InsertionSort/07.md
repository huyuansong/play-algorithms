## 使用插入排序法，优化自底向上的归并排序

在这一小节，我将给出我的参考代码，展示如何使用插入排序法，优化自底向上的归并排序。

同学们可以回忆一下，使用插入排序法优化的原理是，对于小规模的数组，使用插入排序法更快。那么对于自底向上的归并排序，一上来处理的就是基础问题，所以，我们一上来就需要使用插入排序算法，先把小规模的数组进行排序。

我们还是以 16 为例，对数组大小为 16 的数组进行插入排序，算法整体的框架就是这样的：

```
public static <E extends Comparable> void sortBU(E[] arr){

    E[] temp = Arrays.copyOf(arr, arr.length);

    int n = arr.length;

    // 使用插入排序优化
    // 遍历一遍，对所有 arr[i, i + 15] 的区间，使用插入排序法
    // 注意 i 每次加 16
    for(int i = 0; i < n; i += 16)
        InsertionSort.sort(arr, i, Math.min(i + 15, n - 1)); // 也要注意这里 Math.min 的用法

    // ... 然后进行自底向上的归并排序 
}
```

在这个基础上，我们上一小节写的自底向上的归并排序的代码还需不需要修改呢？需要，但其实，只需要修改一点就好，那就是 sz 从 16 开始，而不是从 1 开始。就是这么简单！

```
// 遍历合并的区间长度
// 注意，sz 从 16 开始
for(int sz = 16; sz < n; sz += sz){

        // 遍历合并的两个区间的起始位置 i
        // 合并 [i, i + sz - 1] 和 [i + sz, i + sz + sz - 1]
        for(int i = 0; i + sz < n; i += sz + sz)
            if(arr[i + sz - 1].compareTo(arr[i + sz]) > 0)
                merge(arr, i, i + sz - 1, Math.min(i + sz + sz - 1, n - 1), temp);
}
```

怎么样？是不是很简单？也很酷？我们最终的完整代码是这样的：

```
public static <E extends Comparable> void sortBU(E[] arr){

    E[] temp = Arrays.copyOf(arr, arr.length);

    int n = arr.length;

    // 使用插入排序优化
    // 遍历一遍，对所有 arr[i, i + 15] 的区间，使用插入排序法
    for(int i = 0; i < n; i += 16)
        InsertionSort.sort(arr, i, Math.min(n - 1, i + 15));

    // 遍历合并的区间长度
    // 注意，sz 从 16 开始
    for(int sz = 16; sz < n; sz += sz){

        // 遍历合并的两个区间的起始位置 i
        // 合并 [i, i + sz - 1] 和 [i + sz, i + sz + sz - 1]
        for(int i = 0; i + sz < n; i += sz + sz)
            if(arr[i + sz - 1].compareTo(arr[i + sz]) > 0)
                merge(arr, i, i + sz - 1, Math.min(i + sz + sz - 1, n - 1), temp);
    }
}
```

有兴趣的同学，可以测试一下，这样优化以后，在你的环境下，自底向上的归并排序法的性能有没有提高？

<br/>

最后，关于我们使用的 16 这个数字，我多说一句。

很多同学可能会问，16 这个数字怎么来的？答案是：这是一个经验数字。

那么这个数字，一定用 16 吗？答案是不一定。如果你愿意，使用 8，32，或者 10，都是可以的。但是，不同的数字，在不同的环境下，可能对性能的影响是不一样的。

在算法领域，这叫做超参数，也就这个参数是在执行算法前决定的，而不是根据算法的逻辑推导计算出的一个参数。如果有同学接触过机器学习，就会知道，在机器学习的世界中，含有大量的算法需要使用超参数。

超参数的概念，在我们这个课程后续还会给大家介绍。等我们学习希尔排序：另外一种排序算法时，大家会看到一种更有意思的超参数。

对于超参数，有一个有意思的话题，就是这个参数取多少的时候，在你的环境下会达到性能最优？如果一定要求解出这个问题，通常的方法是，循环迭代这个超参数，尝试不同的超参数，计算性能，看看大概超参数的取值是多少的时候，在你的环境下性能达到最优。

有兴趣的同学，也可以做一下这个实验哦。

<br/>

**大家加油！：）**
